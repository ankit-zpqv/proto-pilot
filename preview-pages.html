<!-- preview-pages.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preview Pages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Inter font for better typography -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .preview-frame {
        width: 100%;
        height: 600px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
      }
      .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <header class="bg-white shadow-sm">
      <nav
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between"
      >
        <div class="flex items-center">
          <div class="logo font-bold text-blue-600 text-xl">App Preview</div>
        </div>
        <div class="flex space-x-4">
          <a
            href="/index.html"
            class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
            >Home</a
          >
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Loading State -->
      <div
        id="loadingState"
        class="hidden flex items-center justify-center p-8"
      >
        <div class="loading-spinner"></div>
        <span class="ml-3 text-gray-600">Loading previews...</span>
      </div>

      <!-- Error Message -->
      <div
        id="errorMessage"
        class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md mb-6"
      >
        Failed to load preview. Please check the URL and try again.
      </div>

      <!-- Preview Navigation -->
      <div id="previewNav" class="hidden mb-6">
        <div class="border-b border-gray-200">
          <nav class="flex space-x-8" aria-label="Preview navigation">
            <!-- Preview tabs will be inserted here -->
          </nav>
        </div>
      </div>

      <!-- Preview Container -->
      <div id="previewContainer" class="hidden">
        <!-- Preview frames will be inserted here -->
      </div>
    </main>

    <script>
      async function fetchPreview() {
        const urlParams = new URLSearchParams(window.location.search);
        const url = urlParams.get("url");
        const loadingState = document.getElementById("loadingState");
        const errorMessage = document.getElementById("errorMessage");
        const previewNav = document.getElementById("previewNav");
        const previewContainer = document.getElementById("previewContainer");

        // Reset states
        loadingState.classList.remove("hidden");
        errorMessage.classList.add("hidden");
        previewNav.classList.add("hidden");
        previewContainer.classList.add("hidden");

        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();

          // Create preview tabs and containers
          const navHtml = data
            .map(
              (page, index) => `
                    <button class="preview-tab ${
                      index === 0
                        ? "border-b-2 border-blue-600 text-blue-600"
                        : "text-gray-500"
                    } 
                        whitespace-nowrap py-4 px-1 font-medium text-sm"
                        onclick="switchPreview('${page.pageName}')">
                        ${page.pageName}
                    </button>
                `
            )
            .join("");

          const previewsHtml = data
            .map((page) => {
              try {
                // First, parse any escaped characters in the code string
                // This converts "\n" to actual newlines, etc.
                const decodedCode = page.code.replace(/\\n/g, "\n");

                // For srcdoc, we only need to escape quotes to prevent breaking the attribute
                // We DON'T escape HTML tags as they should be rendered as HTML
                const escapedForAttribute = decodedCode
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#39;");

                return `
                    <div id="preview-${
                      page.pageName
                    }" class="preview-frame-container ${
                  page.pageName === data[0].pageName ? "" : "hidden"
                }">
                        <iframe
                            class="preview-frame"
                            sandbox="allow-scripts"
                            srcdoc="${escapedForAttribute}">
                        </iframe>
                    </div>
                `;
              } catch (error) {
                console.error("Error processing page:", page.pageName, error);
                return "";
              }
            })
            .join("");

          previewNav.querySelector("nav").innerHTML = navHtml;
          previewContainer.innerHTML = previewsHtml;

          previewNav.classList.remove("hidden");
          previewContainer.classList.remove("hidden");
        } catch (error) {
          errorMessage.classList.remove("hidden");
          console.error("Error:", error);
        } finally {
          loadingState.classList.add("hidden");
        }
      }

      function switchPreview(pageName) {
        // Update tab styles
        document.querySelectorAll(".preview-tab").forEach((tab) => {
          tab.classList.remove(
            "border-b-2",
            "border-blue-600",
            "text-blue-600"
          );
          tab.classList.add("text-gray-500");
        });
        const activeTab = document.querySelector(
          `[onclick="switchPreview('${pageName}')"]`
        );
        activeTab.classList.add(
          "border-b-2",
          "border-blue-600",
          "text-blue-600"
        );
        activeTab.classList.remove("text-gray-500");

        // Show selected preview
        document
          .querySelectorAll(".preview-frame-container")
          .forEach((container) => {
            container.classList.add("hidden");
          });
        document
          .getElementById(`preview-${pageName}`)
          .classList.remove("hidden");
      }

      fetchPreview();
    </script>
  </body>
</html>
